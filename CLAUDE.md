# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ğŸ Python Environment Rules

**CRITICAL**: This project uses **UV** for all Python operations. Never use `python -m`, `pip install`, or `python script.py` directly.

### Required Commands

```bash
# All Python operations must use UV
uv run pytest                    # Run tests
uv run pytest tests/pm_agent/   # Run specific tests
uv pip install package           # Install dependencies
uv run python script.py          # Execute scripts
```

## ğŸ“‚ Project Structure

**ABI-first runtime**: Python modules provide typed request/response DTOs for confidence gating, repository indexing, and deep-research planning. Plugin artifacts are generated from unified sources.

```
# Python Package (primary)
src/airis_agent/
â”œâ”€â”€ api/                 # ABI endpoints (confidence, repo_index, deep_research)
â”œâ”€â”€ cli/                 # CLI (doctor, version, install-skill commands)
â”œâ”€â”€ execution/           # parallel.py, reflection.py, self_correction.py
â”œâ”€â”€ pm_agent/            # confidence.py, self_check.py, reflexion.py
â”œâ”€â”€ pytest_plugin.py     # Auto-loaded pytest integration
â””â”€â”€ skills/              # TypeScript skills bundled with Python package

# Plugin Build System
plugins/airis-agent/      # Plugin source (manifest templates, tests)
â”œâ”€â”€ manifest/             # metadata.json, plugin.template.json, marketplace.template.json
â””â”€â”€ tests/                # Plugin smoke tests

dist/plugins/airis-agent/ # Built plugin artifacts (generated by make build-plugin)
â””â”€â”€ .claude-plugin/       # Manifests: plugin.json, marketplace.json
    â””â”€â”€ tests/            # Plugin tests

# Legacy directories (being phased out)
setup/                    # Old component structure
superclaude/              # Legacy CLI (pre-rebrand to airis-agent)

# Project Documentation
tests/                    # Python test suite
docs/                     # Architecture, guides, research
scripts/                  # Build/publish helpers
```

## ğŸ”§ Development Workflow

### Essential Commands

```bash
# Setup
make install          # Install in editable mode with dev dependencies (uv pip install -e ".[dev]")
make verify           # Verify installation (package, plugin, health)

# Testing
make test             # Run full test suite
uv run pytest tests/pm_agent/ -v              # Run specific directory
uv run pytest tests/test_file.py -v           # Run specific file
uv run pytest -m confidence_check             # Run by marker
uv run pytest --cov=airis_agent               # With coverage

# Code Quality
make lint             # Run ruff linter
make format           # Format code with ruff
make doctor           # Health check diagnostics

# Plugin Packaging
make build-plugin            # Build plugin artifacts into dist/plugins/airis-agent/
make sync-plugin-repo        # Sync artifacts into ../Super Agent_Plugin

# Maintenance
make clean            # Remove build artifacts
```

## ğŸ“¦ Core Architecture

### Why This Architecture Exists

**ABI-first design**: Python modules under `src/airis_agent/api/` provide a reusable ABI (Application Binary Interface) so MCP gateways, CLIs, and IDEs can share the same workflow logic without duplicating slash-command specs.

**Single source of truth**: The runtime (confidence gate, parallel executor, reflexion/self-check, repo indexer) lives in one package. Plugin artifacts are generated from it, preventing drift.

**Host-agnostic**: Works with Claude Code, Codex CLI, Gemini CLI, Cursor, or any tool that can call the Python API.

### Pytest Plugin (Auto-loaded)

Registered via `pyproject.toml` entry point, automatically available after installation.

**Fixtures**: `confidence_checker`, `self_check_protocol`, `reflexion_pattern`, `token_budget`, `pm_context`

**Auto-markers**:
- Tests in `/unit/` â†’ `@pytest.mark.unit`
- Tests in `/integration/` â†’ `@pytest.mark.integration`

**Custom markers**: `@pytest.mark.confidence_check`, `@pytest.mark.self_check`, `@pytest.mark.reflexion`

### PM Agent - Three Core Patterns

**1. ConfidenceChecker** (src/airis_agent/pm_agent/confidence.py)
- Pre-execution confidence assessment: â‰¥90% required, 70-89% present alternatives, <70% ask questions
- Prevents wrong-direction work, ROI: 25-250x token savings

**2. SelfCheckProtocol** (src/airis_agent/pm_agent/self_check.py)
- Post-implementation evidence-based validation
- No speculation - verify with tests/docs

**3. ReflexionPattern** (src/airis_agent/pm_agent/reflexion.py)
- Error learning and prevention
- Cross-session pattern matching

### Parallel Execution

**Wave â†’ Checkpoint â†’ Wave pattern** (src/airis_agent/execution/parallel.py):
- 3.5x faster than sequential execution
- Automatic dependency analysis
- Example: [Read files in parallel] â†’ Analyze â†’ [Edit files in parallel]

### ABI Endpoints (src/airis_agent/api/)

These modules provide the public API surface for Airis Agent runtime:

**1. Confidence Gate** (`confidence.py`)
- Pre-implementation confidence assessment
- Returns score (0.0-1.0), action (proceed/alternatives/ask), and checklist
- Prevents wrong-direction work: 25-250x token savings

**2. Repository Index** (`repo_index.py`)
- Generates `PROJECT_INDEX.{md,json}` with codebase structure
- Optional on-disk output
- 94% token reduction for context

**3. Deep Research** (`deep_research.py`)
- Creates wave/queries plan for multi-step research
- Returns findings, sources, and confidence scores
- Integrates with Tavily (web search) and Context7 (official docs)

**Usage**: Import and call directly from Python, or expose via MCP gateway for LLM access.

### Plugin Packaging

**Build process**: `make build-plugin` renders plugin manifests from templates:
- Source: `plugins/airis-agent/manifest/*.template.json`
- Output: `dist/plugins/airis-agent/.claude-plugin/plugin.json`

**Distribution**: Use `make sync-plugin-repo` to push built artifacts into `../Super Agent_Plugin` for marketplace distribution.

## ğŸ§ª Testing with PM Agent

### Example Test with Markers

```python
@pytest.mark.confidence_check
def test_feature(confidence_checker):
    """Pre-execution confidence check - skips if < 70%"""
    context = {"test_name": "test_feature", "has_official_docs": True}
    assert confidence_checker.assess(context) >= 0.7

@pytest.mark.self_check
def test_implementation(self_check_protocol):
    """Post-implementation validation with evidence"""
    implementation = {"code": "...", "tests": [...]}
    passed, issues = self_check_protocol.validate(implementation)
    assert passed, f"Validation failed: {issues}"

@pytest.mark.reflexion
def test_error_learning(reflexion_pattern):
    """If test fails, reflexion records for future prevention"""
    pass

@pytest.mark.complexity("medium")  # simple: 200, medium: 1000, complex: 2500
def test_with_budget(token_budget):
    """Token budget allocation"""
    assert token_budget.limit == 1000
```

## ğŸŒ¿ Git Workflow

**Branch structure**: `main` (production) â† `next` (testing) â† `feature/*`, `fix/*`, `docs/*`

**Standard workflow**:
1. Create branch from `next`: `git checkout -b feature/your-feature`
2. Develop with tests: `uv run pytest`
3. Commit: `git commit -m "feat: description"` (conventional commits)
4. Merge to `next` â†’ validate â†’ merge to `main`

**Current branch**: `next` (see git status in session start output)

### Parallel Development with Git Worktrees

**CRITICAL**: When running multiple Claude Code sessions in parallel, use `git worktree` to avoid conflicts.

```bash
# Create worktree for next branch
cd ~/github/airis-agent
git worktree add ../airis-agent-next next

# Create worktree for feature branch
git worktree add ../airis-agent-feature feature/pm-agent
```

**Benefits**:
- Run Claude Code sessions on different branches simultaneously
- No branch switching conflicts
- Independent working directories
- Parallel development without state corruption

**Usage**:
- Session A: Open `~/github/airis-agent/` (current branch: next)
- Session B: Open `~/github/airis-agent-next/` (next)
- Session C: Open `~/github/airis-agent-feature/` (feature branch)

**Cleanup**:
```bash
git worktree remove ../airis-agent-next
```

## ğŸ“ Key Documentation Files

Additional docs in `docs/user-guide/`, `docs/developer-guide/`, `docs/reference/`, `docs/architecture/`

## ğŸ’¡ Core Development Principles

### 1. Evidence-Based Development
**Never guess** - verify with official docs (Context7 MCP, WebFetch, WebSearch) before implementation.

### 2. Confidence-First Implementation
Check confidence BEFORE starting: â‰¥90% proceed, 70-89% present alternatives, <70% ask questions.

### 3. Parallel-First Execution
Use **Wave â†’ Checkpoint â†’ Wave** pattern (3.5x faster). Example: `[Read files in parallel]` â†’ Analyze â†’ `[Edit files in parallel]`

### 4. Token Efficiency
- Simple (typo): 200 tokens
- Medium (bug fix): 1,000 tokens
- Complex (feature): 2,500 tokens
- Confidence check ROI: spend 100-200 to save 5,000-50,000

## ğŸ”§ MCP Server Integration

Integrates with multiple MCP servers via **airis-mcp-gateway**.

**High Priority**:
- **Tavily**: Web search (Deep Research)
- **Context7**: Official documentation (prevent hallucination)
- **Sequential**: Token-efficient reasoning (30-50% reduction)
- **Serena**: Session persistence
- **Mindbase**: Cross-session learning

**Optional**: Playwright (browser automation), Magic (UI components), Chrome DevTools (performance)

**Usage**: TypeScript plugins and Python pytest plugin can call MCP servers. Always prefer MCP tools over speculation for documentation/research.

## ğŸš€ Plugin Development

### Build System

Plugin artifacts are generated from source templates:

```bash
# Build plugin manifests and copy assets
make build-plugin

# Sync to distribution repository (optional)
make sync-plugin-repo PLUGIN_REPO=/path/to/Airis Agent_Plugin
```

**Source**: `plugins/airis-agent/manifest/` contains:
- `metadata.json` - Plugin metadata (name, version, description, etc.)
- `plugin.template.json` - Plugin manifest template
- `marketplace.template.json` - Marketplace listing template

**Output**: `dist/plugins/airis-agent/.claude-plugin/` contains rendered manifests.

### Editing Workflow

1. Update metadata: `plugins/airis-agent/manifest/metadata.json`
2. Build: `make build-plugin`
3. Verify: Check `dist/plugins/airis-agent/.claude-plugin/plugin.json`
4. (Optional) Sync to distribution repo: `make sync-plugin-repo`

**Distribution Package** (`../Super Agent_Plugin`):
- Contains generated artifacts for marketplace
- Do not edit manually - regenerate via `make sync-plugin-repo`

## ğŸ“Š Package Information

**Package name**: `airis-agent`
**Version**: 1.0.0
**Python**: >=3.10
**Build system**: hatchling (PEP 517)

**Entry points**:
- CLI: `airis-agent` command (via `airis_agent.cli.main:main`)
- Pytest plugin: Auto-loaded as `airis-agent` (via `airis_agent.pytest_plugin`)

**Dependencies**:
- pytest>=7.0.0 (testing framework)
- click>=8.0.0 (CLI framework)
- rich>=13.0.0 (terminal formatting)

**Installation**:
```bash
# Development mode (recommended)
make install  # or: uv pip install -e ".[dev]"

# Verify installation
make verify
uv run airis-agent doctor
```
